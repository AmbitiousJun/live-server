<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAD8/v7//P7+//z+/v/8/v7//P7+//v9/f/////////////////6/Pz/+/z8///////////////////////////////////////////////////////7/fz/+/39//////////////////v9/f/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/7/f3//////+Pk5P+QlJX/xMXE////////////7e/2/9vd5P/NztT/xMXK/8HCxv/Bw8f/xcfM/8zO0//Z2+H/7O71////////////vsC//5OYmf/l5ub///////v9/f/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//n7+///////mZqa/0p1k/9Wf6L/cXBv/4+Pfv+Egl7/iohW/5COUv+UklH/mJZS/5iVUv+Vk1L/kI1S/4mHVP+FhF3/kZF7/21taf9Vf6P/SnWT/5+hoP//////+fv7//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7/+/39///////09fb/Wmdv/36FYP+0sFv/0s5p/+Pfdf/o5Xr/6ud8/+rnff/q533/6ud9/+rnff/q53z/6eV6/+Pfdf/U0Gv/tLBc/4qRZf9aZWn/7u/y///////7/f3//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/6/Pz//////56fnf+knlP/3tlx/7m4af+lo2D/l5NY/42JUv+GgU7/g31M/4F8S/+Aekr/gXxM/4eDT/+QjVX/m5pb/7CuZP/b2Hb/5N51/6ulVf+PkIj///////v9/P/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7/+/z8///////S1Nv/iIZP/8/Mbv9PTD7/OC4u/zMtMP8yMjf/MDU+/zI6Q/8yPUb/MTxG/zA8Rv8zPUb/MTc//zIxOP82LjD/OTAz/2RiRf/Oy2//5OF7/5GOTP++v8T///////r8/P/8/v7//P7+//z+/v/8/v7//P7+//z+/v/5+/v//////5qbl//Cv2H/iIZV/zEvOf9BfY7/T67I/1i/2v9TweD/Tr/h/1vO7P9azez/TsLl/1XI6P9ayOT/SrDQ/0ypw/9HanL/Ny80/6qpYP/e23n/xcFk/46Nfv//////+vz8//z+/v/8/v7//P7+//z+/v/8/v7//P7+//v9/P//////i4t3/9PRa/9uZkT/OE5Z/1rb/v9Rzfb/W9X5/1/Z+v9Wz/T/Ucnw/17W+P9c1fb/UMjv/1nS9v9e1/n/VNf//02wy/82LzP/l5VZ/93Zdv/V0W//iYdi/+/x+P///////P3+//z+/v/8/v7//P7+//z+/v/8/v7//v////X3/f+JiGn/2ddw/19VO/86XWz/X9v8/1nN7v9Nw+r/Wc/x/17V9f9VzO//UMfs/13T9P9b0vP/T8Xr/1fN7/9e1vj/S7PT/zM0O/+LiFP/3Nl2/9nWc/+Mi1r/4OLp///////7/f3//P7+//z+/v/8/v7//P7+//v9/f//////7O71/4iHYf/a2XL/WU44/zdgcv9U0/n/XtPz/1nQ8v9NxOv/WNDy/17V9v9UzPD/UMft/13U9f9c0/T/T8Xr/1nS9v9Zx+T/MzhB/4N/Tv/b2HX/2tZ0/4+NV//W2N////////r8/P/8/v7//P7+//z+/v/8/v7//f/////////09Pn/jYxk/9rYcv9VSjb/P2p5/1TU+v9Sx+z/XtX2/1nQ8/9MxOv/WM/y/17W9v9VzPD/UMft/13U9f9b0vP/UMnw/1PD4/82PUX/f3pM/+LfeP/h3Xb/lpRZ/9zc4f///////P7///z+/v/8/v7//P7+//z+/v//////k5qd/3qFkv+Fglj/3Np0/1VKNv89Znb/YN///1HH7P9Sye7/XtX2/1nR8/9NxOv/V8/y/17W9v9VzPD/UMft/1zT9P9d1vj/TL3e/zI5Q/+Ef0//hIJR/2VjRf+RjlT/dn6I/5Sbnv/5+fn//f////z+/v/7/f3//////+Ti4P9MZnX/ZaLT/3l9Wf/f23T/WE45/zdcbP9U0ff/XtTz/1LJ7v9Sye7/XtX2/1rR8/9NxOv/V87x/17W9v9UzPD/UMbs/17X+f9Ww9//MzdA/4SAT/9xb0r/UE0//4aETf9jm8b/TGuA/9nX1f//////+/z9//z+/v/7/f7//////7rAwv9pgpj/eXxY/+Hedf9dVDv/O1ll/1TT+f9TyO3/XtT1/1LI7f9Qxuv/XdPz/1rQ8f9Nw+n/V83w/1/V9f9Vy+7/VNH5/1W+2v80MTj/iYZT/7i1ZP+koVr/mJda/2F1if+9w8X///////v9/v/8/v7//P7+//z+/v/8/v7//////+nn6v+DgVv/4t91/2hjRf85QEj/Vb7X/1PO8/9T0PX/X93+/1TS+P9U0vr/YN7//17c//9Oy/P/VtL2/1zU9P9SyOv/QoSV/zwzOP+Ih1H/VVNB/zc0Ov9xb0X/2tjZ///////7/f3//P7+//z+/v/8/v7//P7+//z9/v/+//7/7vH4/4qJY//i3nX/kZBW/zEsNf83OkH/OE9a/zZUY/87XWv/Qmh1/zNbaP8wWGP/Nltl/0BgbP84U2D/O09Z/zhAR/87NTv/NjM3/7KvYf+PjFX/eHVN/4mHVP/X2uH///////v8/f/8/v7//P7+//z+/v/8/v7//P7+//7////2+P7/fXxd/9fTa//Y1HX/mJZY/3NvSf9lXT7/XFM6/1pRPP8+MR7/g3dw/6Salf+ShoL/PTAg/1pSPf9aUjz/ZF9D/25tSf+gnlr/19Rz/+Ddd//h3W//cnBJ/+Lk6///////+/39//z+/v/8/v7//P7+//z+/v/8/v7/+vz8//////+4ubj/fHtS/9HNcP/d2nf/4N14/+Xiev/Z13D/1NBq/2t5ZP97ma//hJWe/4Kesf9fcm7/x8Rn/93bcf/j4Hf/4N14/9rWdf/Z1XT/oqBd/3d2X/+wsbD///////v9/f/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7/+fv6//////+Vlpb/s7Ba/9vYef/Jxmn/joxV/5GRcv94c07/UHKJ/3eu1v9JYG//caPF/1qGqP9rZ0T/lZRv/4+NVv/IxWj/1NF0/9fUb/99fFz/6uz4///////7/f3//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/5+/v//////6ytrP+qp1j/29dz/4GAYP/Mztf/+Pr///////+oqqr/KSkk/0A3M/8nJSL/lpiY//r8///19/3/0NLb/4KBZP/Py2z/089t/4eHa//6/P//+/z7//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//r8/P//////xcfM/6OhW/+rqFv/ubvC////////////vr+9/7q7vv+OjXn/paNR/4mIcv/Fxsr/uLq4////////////xMXN/52bWf/RzWn/kZCA///////7/Pz//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7/+vz8///////i5PH/hYRY/52bW//Z2+L///////////8+Pjz/SUlL/6ionv+0sFH/r6+f/0pKTf80NDL/+Pr6///////j5ez/nJpk/7CtV/+QkZj///////n7+//8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//v9/f//////6uzw/4SEb/93dUj/l5RR/76/w////////////9rb2f/a3OH/kZF+/8fDXv+Qj3X/1dbd/9HSz//+/////////8LDzP+npFv/jYtS/29tSf+1trP///////r8/P/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7/+vv7//////+ZmpX/t7NX/4J/Tv9pZz7/l5Zr/9XW3//5+////f///6eorP+Zl1X/5OF7/6ShV/+am5r/+fv///f5///U1uH/mJdw/5mWU/9MSjb/0s5r/4SCWf/q7PP///////z9/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/6+/v//////5ydlv+qplH/tbJk/42KTf9dWzP/e3lF/5WUcP+Uk2n/rapb/+Hdd//X03T/4d54/7SxXf+TkWT/l5Zw/4eFTP96dz//bGo//62qX/++umL/h4Vc/+vt9P///////P3+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//v9/f//////6uzw/4WEbv+YlVf/i4ps/7u8xP+amoz/f31T/5KPTv+mo1f/tbJl/7u4Z/+5tmf/rqtf/5aTTv+Fg1H/iopx/7q7wf+bnJL/lZJW/4SCVP+0tbb///////r8/P/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//f7+//v9/f//////+vz//9XX3//09vv////////////q7PT/0dLa/6Wnq/8oJib/NTIx/yQhIP9NTVD/y83U/+Di6v/+///////////////W2OD/4uTr///////7/f3//f7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//f7+//v9/f/9//7///////7////5+/v/+vv7//7//v//////m5ua/4aHhv+/v7//rK2t/2trav////////////r7+//5+/v/+/38////////////+vz8//3+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/7/f3//P7+//z+/v/8/v7//////5SVlP+MjIz/////////////////w8TE/29vbv////////////v9/f/8/v7/+/39//v9/f/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//f7+//3+/v/8/v7//P7+//3+/v/8/v7//P7+//z+/v/8/v7//P3+//////+fn5//nZ2d///////6/Pz/+fv7//b4+P//////ubq5/4iIiP///////P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//f7+//z+/v/9/v7//P7+//z+/v/8/v7//P7+//z+/v/8/v7//P7+//r8/P//////wcLC/5iYmP//////+fv7//z+/v/9/v7//f7///j5+v//////oKGh/8bHx///////+vz8//z+/v/8/v7//P7+//3+/v/9/v7//P7+//z+/v/8/v7//P7+//3+/v/8/v7//P7+//3+/v/8/v7//P7+//z+/v/8/v7//P7+//3+///7/P3///////v9/f/8/v7//f7+//3+/v/9/v7//f7+//v8/P///////v////z+/v/8/v7//P7+//3+/v/8/v7//P7+//3+/v/9/v7//P7+//3+/v/9/v7/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=">
    <title>live-server 配置页</title>
    <!-- 引入 Bootstrap CSS -->
    <link
      href="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .page-container {
        padding: 20px 10px;
      }
      .page-container input,
      .page-container textarea,
      .page-container .button-group {
        margin: 8px 0;
      }
      .env-wrap .env-value {
        overflow-wrap: break-word;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div class="page-container">
      <h2>live-server 配置页</h2>

      <!-- 展示用户传递的程序密钥 -->
      <div class="mb-3 row secret-wrap">
        <label class="col-sm-2 col-form-label">程序密钥：</label>
        <div class="col-sm-10">
          <input class="form-control secret" type="text" disabled />
        </div>
      </div>

      <!-- 环境变量 -->
      <div class="env-wrap">
        <h3>环境变量</h3>
        <div class="mb-3 row">
          <div class="col-sm-6">
            <input
              class="form-control env-key"
              type="text"
              placeholder="在此输入 key, 如: feng_token"
            />
          </div>
          <div class="col-sm-6 button-group">
            <button type="button" class="btn btn-success" onclick="getEnv()">
              查 询
            </button>
            <button type="button" class="btn btn-primary" onclick="setEnv()">
              添 加
            </button>
            <button type="button" class="btn btn-danger" onclick="delEnv()">
              删 除
            </button>
          </div>
          <div class="col-sm-12">
            <textarea
              class="form-control env-value"
              rows="6"
              style="overflow: hidden; resize: none"
              placeholder="在此输入想更新的 value, 通过查询得到的值也会显示在此"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- 黑名单 -->
      <div class="black-ip-wrap">
        <h3>黑名单</h3>
        <div class="mb-3 row">
          <div class="col-sm-10">
            <input
              class="form-control black-ip"
              type="text"
              placeholder="请输入要加入黑名单的 ip, 如: 1.1.1.1"
            />
          </div>
          <div class="col-sm-2 button-group">
            <button
              type="button"
              class="btn btn-primary"
              onclick="setBlackIp()"
            >
              添 加
            </button>
          </div>
        </div>
      </div>

      <!-- 地域白名单 -->
      <div class="white-area-wrap">
        <h3>地域白名单</h3>
        <div class="mb-3 row">
          <div class="col-sm-8">
            <input
              class="form-control white-area"
              type="text"
              placeholder="请输入要加入白名单的地域, 如: 广东/佛山/南海"
            />
          </div>
          <div class="col-sm-4 button-group">
            <button
              type="button"
              class="btn btn-primary"
              onclick="setWhiteArea('set')"
            >
              添 加
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="setWhiteArea('del')"
            >
              移 除
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
    // 获取基本参数
    const getBaseParams = () => {
      const secret = new URL(window.location.href).searchParams.get("secret");
      return {
        secret, // 程序密钥
        host: "", // 发送请求的主机地址
      };
    };

    // 根据文本框内容自动调整环境变量框的高度
    const autoResizeEnvValueTextarea = (initEvent = false) => {
      const textarea = document.querySelector(".env-wrap .env-value");

      // 核心调整函数
      const autoResize = () => {
        textarea.style.height = "auto";
        textarea.style.height = `${textarea.scrollHeight}px`;
      };

      if (initEvent) {
        // 输入事件监听
        textarea.addEventListener("input", autoResize);

        // 窗口尺寸变化监听（带防抖）
        let resizeTimer;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(autoResize, 150);
        });
      }

      // 初始化执行
      autoResize();
    };

    window.onload = () => {
      // 设置程序密钥
      const { secret } = getBaseParams();
      document.querySelector(".page-container .secret").value = secret;

      autoResizeEnvValueTextarea(true);
    };

    // 获取输入框的值
    const getInputValue = (selector = "") => {
      return (document.querySelector(selector).value || "").trim();
    };

    // 设置输入框的值
    const setInputValue = (selector = "", value = "") => {
      const target = document.querySelector(selector);
      if (!target) {
        return;
      }
      target.value = value;
    };

    // GET 请求指定地址
    const fetchUrl = (
      url = "",
      successFunc = () => {},
      errorFunc = (err) => {}
    ) => {
      fetch(url)
        .then((res) => {
          if (res.ok) {
            return successFunc();
          }
          errorFunc(res.statusText);
        })
        .catch((err) => {
          errorFunc(err);
        });
    };

    // 查询环境变量
    const getEnv = () => {
      const envKey = getInputValue(".env-wrap .env-key");
      if (envKey === "") {
        return alert("输入参数不能为空");
      }

      const { secret, host } = getBaseParams();
      const url = `${host}/env?key=${envKey}&secret=${secret}`;
      fetch(url)
        .then((res) => {
          if (!res.ok) {
            return alert(`查询失败: ${res.statusText}`);
          }
          return res.text();
        })
        .then((respText) => {
          setInputValue(".env-wrap .env-value", respText);
          autoResizeEnvValueTextarea(false);
        })
        .catch((err) => {
          alert(`查询失败: ${err}`);
        });
    };

    // 设置环境变量
    const setEnv = () => {
      const envKey = getInputValue(".env-wrap .env-key");
      const envValue = getInputValue(".env-wrap .env-value");
      if (envKey === "" || envValue === "") {
        return alert("输入参数不能为空");
      }

      const { secret, host } = getBaseParams();
      const url = `${host}/env?secret=${secret}`;
      const formData = new FormData();
      formData.append("key", envKey);
      formData.append("value", envValue);

      fetch(url, {
        method: "POST",
        body: formData,
      })
        .then((res) => {
          if (res.ok) {
            return alert("添加成功");
          }
          alert(`添加失败: ${res.statusText}`);
        })
        .catch((err) => {
          alert(`添加失败: ${err}`);
        });
    };

    // 删除环境变量
    const delEnv = () => {
      const envKey = getInputValue(".env-wrap .env-key");
      if (envKey === "") {
        return alert("输入参数不能为空");
      }

      const { secret, host } = getBaseParams();
      const url = `${host}/env?secret=${secret}`;
      const formData = new FormData();
      formData.append("key", envKey);

      fetch(url, {
        method: "DELETE",
        body: formData,
      })
        .then((res) => {
          if (res.ok) {
            setInputValue(".env-wrap .env-value", "");
            return alert("删除成功");
          }
          alert(`删除失败: ${res.statusText}`);
        })
        .catch((err) => {
          alert(`删除失败: ${err}`);
        });
    };

    // 设置黑名单 ip
    const setBlackIp = () => {
      const blackIp = getInputValue(".black-ip-wrap .black-ip");
      if (blackIp === "") {
        return alert("参数不能为空");
      }
      const { secret, host } = getBaseParams();
      const url = `${host}/black_ip?ip=${blackIp}&secret=${secret}`;
      fetchUrl(
        url,
        () => alert("添加成功"),
        (err) => alert(`添加失败: ${err}`)
      );
    };

    // 设置地域白名单
    const setWhiteArea = (action = "set") => {
      const whiteArea = getInputValue(".white-area-wrap .white-area");
      if (whiteArea === "") {
        return alert("输入参数不能为空");
      }
      const actionTip = action === "set" ? "添加" : "移除";
      const { secret, host } = getBaseParams();
      const url = `${host}/white_area/${action}?area=${whiteArea}&secret=${secret}`;
      fetchUrl(
        url,
        () => alert(`${actionTip}成功`),
        (err) => alert(`${actionTip}失败: ${err}`)
      );
    };
  </script>
</html>
